# è§£å†³NaN Lossé—®é¢˜ - å®Œæ•´æŒ‡å—

## âš ï¸ é‡è¦æ›´æ–°: é—®é¢˜å·²æ‰¾åˆ°å¹¶ä¿®å¤!

**æ ¹æœ¬åŸå› **: `layers/Cluster.py` ä¸­çš„å‚æ•°`D`ä½¿ç”¨äº†**æœªåˆå§‹åŒ–çš„`torch.Tensor()`**,åŒ…å«éšæœºåƒåœ¾å€¼(å¯èƒ½æ˜¯NaN/Inf)!

**å…³é”®ä¿®å¤**: å·²å°†`torch.Tensor()`æ›¿æ¢ä¸ºæ­£ç¡®çš„æ­£äº¤åˆå§‹åŒ–ã€‚è¯¦è§ `PROBLEM_SOLVED.md`

---

## é—®é¢˜è¯Šæ–­

æ ¹æ®æ‚¨çš„é”™è¯¯è¾“å‡º:
```
loss_fore: nan, loss_cluster_time: nan, loss_cluster_frequency: nan
outputs range: [nan, nan]
batch_y range: [-0.8007380366325378, 3.080836296081543]
```

**æ ¸å¿ƒé—®é¢˜**: æ¨¡å‹è¾“å‡ºå°±æ˜¯NaN,ä¸æ˜¯lossè®¡ç®—çš„é—®é¢˜ã€‚

## å·²ä¿®å¤çš„é—®é¢˜

### 1. RevINå±‚çš„æ•°å€¼ç¨³å®šæ€§é—®é¢˜ âœ“ (å·²ä¿®å¤)

**ä½ç½®**: `layers/RevIN.py`

**é—®é¢˜**:
- `_denormalize`æ–¹æ³•ä¸­ä½¿ç”¨äº†`eps*eps`(1e-10),å¤ªå°äº†
- æ²¡æœ‰é˜²æ­¢`stdev`æ¥è¿‘0çš„æƒ…å†µ
- æ²¡æœ‰é˜²æ­¢`affine_weight`æ¥è¿‘0çš„æƒ…å†µ

**ä¿®å¤**:
- åœ¨`_get_statistics`ä¸­æ·»åŠ `torch.clamp(self.stdev, min=self.eps)`
- åœ¨`_denormalize`ä¸­ä½¿ç”¨å®‰å…¨çš„é™¤æ³•

### 2. æ•°æ®åŠ è½½çš„NaNå¤„ç† âœ“ (å·²ä¿®å¤)

**ä½ç½®**: `data_provider/data_loader.py` -> `Dataset_Solar.__read_data__`

**ä¿®å¤**:
- æ·»åŠ äº†NaNå’ŒInfå€¼æ£€æµ‹ä¸å¡«å……
- åœ¨æ ‡å‡†åŒ–åå†æ¬¡æ£€æŸ¥å¹¶å¤„ç†å¼‚å¸¸å€¼

### 3. è®­ç»ƒä»£ç çš„è°ƒè¯•ä¿¡æ¯ âœ“ (å·²æ·»åŠ )

**ä½ç½®**: `exp/exp_main.py`

**æ·»åŠ **:
- NaN/Infæ£€æµ‹,å‡ºç°æ—¶æ‰“å°è¯¦ç»†ä¿¡æ¯
- æ¢¯åº¦è£å‰ª(max_norm=1.0)
- è¾“å…¥è¾“å‡ºèŒƒå›´æ£€æŸ¥

## ç«‹å³è¡ŒåŠ¨æ­¥éª¤

### æ­¥éª¤1: è¿è¡Œæ¨¡å‹åˆå§‹åŒ–æ£€æŸ¥

```bash
cd scripts
python check_model_init.py
```

è¿™ä¼šæ£€æŸ¥:
- æ¨¡å‹å‚æ•°åˆå§‹åŒ–æ˜¯å¦æœ‰NaN/Inf
- å‰å‘ä¼ æ’­æ˜¯å¦æ­£å¸¸
- ä¸åŒè¾“å…¥è§„æ¨¡ä¸‹çš„è¡Œä¸º
- æ¢¯åº¦æµæ˜¯å¦æ­£å¸¸

### æ­¥éª¤2: ä½¿ç”¨è°ƒè¯•é…ç½®è®­ç»ƒ

```bash
cd scripts
bash solar_debug.sh
```

è°ƒè¯•é…ç½®çš„å…³é”®å‚æ•°:
- å­¦ä¹ ç‡: `1e-6` (é™ä½10å€)
- Batch size: `16` (å‡åŠ)
- Dropout: `0.2` (ç¿»å€)
- Alpha/Gama: `0.1` (é™ä½10å€)

### æ­¥éª¤3: å¦‚æœä»ç„¶NaN

#### é€‰é¡¹A: ç¦ç”¨RevIN

åœ¨`solar_debug.sh`ä¸­æ·»åŠ :
```bash
--revin 0 \
```

#### é€‰é¡¹B: è¿›ä¸€æ­¥é™ä½å­¦ä¹ ç‡

ä¿®æ”¹`solar_debug.sh`:
```bash
LR=0.0000001  # 1e-7
```

#### é€‰é¡¹C: ç¦ç”¨affine

åœ¨`solar_debug.sh`ä¸­ä¿®æ”¹:
```bash
--affine 0 \
```

#### é€‰é¡¹D: å‡å°‘æ¨¡å‹å¤æ‚åº¦

```bash
D_MODEL=8        # ä»16é™åˆ°8
T_NUM_EXPERT=8   # ä»16é™åˆ°8  
F_NUM_EXPERT=8   # ä»16é™åˆ°8
```

## è°ƒè¯•å·¥å…·

### 1. æ•°æ®è´¨é‡æ£€æŸ¥
```bash
python check_solar_data.py
```

### 2. æ¨¡å‹åˆå§‹åŒ–æ£€æŸ¥
```bash
python check_model_init.py
```

## æœ€å¯èƒ½çš„åŸå› æ’åº

1. **RevINå±‚æ•°å€¼ä¸ç¨³å®š** â­â­â­â­â­ (å·²ä¿®å¤)
   - è¿™æ˜¯æœ€å¯èƒ½çš„åŸå› ,å› ä¸ºè¾“å‡ºå…¨æ˜¯NaN
   - affine=0æ—¶å¯èƒ½æ›´ç¨³å®š

2. **å­¦ä¹ ç‡è¿‡å¤§** â­â­â­â­
   - 1e-5å¯¹äºè¿™ä¸ªæ¨¡å‹å¯èƒ½å¤ªå¤§
   - å»ºè®®é™åˆ°1e-6æˆ–æ›´ä½

3. **æ•°æ®æ ‡å‡†åŒ–é—®é¢˜** â­â­â­
   - æŸäº›ç‰¹å¾æ–¹å·®è¿‡å°
   - å·²æ·»åŠ å¤„ç†,ä½†éœ€è¦æ£€æŸ¥

4. **æ¨¡å‹åˆå§‹åŒ–** â­â­
   - MoEæ¶æ„å¯èƒ½åˆå§‹åŒ–ä¸å½“
   - éœ€è¦æ£€æŸ¥expertçš„æƒé‡

5. **æ¢¯åº¦çˆ†ç‚¸** â­
   - å·²æ·»åŠ æ¢¯åº¦è£å‰ª
   - åº”è¯¥æœ‰æ‰€ç¼“è§£

## æ¨èçš„è®­ç»ƒé…ç½®

### é…ç½®1: æœ€ä¿å®ˆ (æœ€ç¨³å®š)
```bash
--revin 0 \
--affine 0 \
--learning_rate 0.0000001 \
--batch_size 8 \
--d_model 8 \
--T_num_expert 4 \
--F_num_expert 4 \
--dropout 0.3 \
--fc_dropout 0.3 \
--alpha 0.01 \
--gama 0.01 \
--beta 0.001
```

### é…ç½®2: å¹³è¡¡ (æ¨è)
```bash
--revin 1 \
--affine 0 \
--learning_rate 0.000001 \
--batch_size 16 \
--d_model 16 \
--T_num_expert 8 \
--F_num_expert 8 \
--dropout 0.2 \
--fc_dropout 0.2 \
--alpha 0.1 \
--gama 0.1 \
--beta 0.01
```

### é…ç½®3: åŸå§‹ (ä¿®å¤åå†è¯•)
```bash
--revin 1 \
--affine 0 \  # æ”¹ä¸º0
--learning_rate 0.00001 \
--batch_size 32 \
--d_model 16 \
--T_num_expert 16 \
--F_num_expert 16 \
--dropout 0.1 \
--fc_dropout 0.1 \
--alpha 1.0 \
--gama 1.0 \
--beta 0.01
```

## ç›‘æ§æŒ‡æ ‡

è®­ç»ƒæ—¶å…³æ³¨:
1. ç¬¬ä¸€ä¸ªiterationçš„è¾“å…¥èŒƒå›´
2. ç¬¬ä¸€ä¸ªiterationçš„è¾“å‡ºèŒƒå›´
3. lossçš„å„ä¸ªç»„æˆéƒ¨åˆ†(loss_fore, loss_cluster_time, loss_cluster_frequency)
4. æ¨¡å‹å‚æ•°æ˜¯å¦æœ‰NaN/Inf

## å¸¸è§é”™è¯¯ä¿¡æ¯åŠè§£å†³

### "outputs range: [nan, nan]"
- **åŸå› **: æ¨¡å‹å‰å‘ä¼ æ’­äº§ç”ŸNaN
- **è§£å†³**: æ£€æŸ¥RevIN,é™ä½å­¦ä¹ ç‡,ç¦ç”¨affine

### "loss_fore: nan"
- **åŸå› **: outputså·²ç»æ˜¯NaN,æˆ–è€…batch_yæœ‰é—®é¢˜
- **è§£å†³**: å…ˆè§£å†³outputsçš„NaN

### "Warning: NaN or Inf loss detected"
- **åŸå› **: å·²ç»è¢«æ•è·äº†
- **è§£å†³**: æŸ¥çœ‹å‰é¢çš„debugä¿¡æ¯

## ä¸‹ä¸€æ­¥

1. âœ… ç«‹å³é‡æ–°è¿è¡Œè®­ç»ƒ,æµ‹è¯•RevINä¿®å¤æ˜¯å¦æœ‰æ•ˆ
2. å¦‚æœè¿˜æ˜¯NaN,è¿è¡Œ`check_model_init.py`
3. æ ¹æ®æ£€æŸ¥ç»“æœé€‰æ‹©é…ç½®1ã€2æˆ–3
4. é€æ­¥å¢åŠ æ¨¡å‹å¤æ‚åº¦

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

- âœ… `layers/RevIN.py` - ä¿®å¤æ•°å€¼ç¨³å®šæ€§
- âœ… `data_provider/data_loader.py` - æ·»åŠ NaNå¤„ç†
- âœ… `exp/exp_main.py` - æ·»åŠ è°ƒè¯•ä¿¡æ¯å’Œæ¢¯åº¦è£å‰ª
- âœ… `scripts/solar_debug.sh` - åˆ›å»ºè°ƒè¯•é…ç½®
- âœ… `scripts/check_model_init.py` - åˆ›å»ºæ£€æŸ¥å·¥å…·

ç¥è®­ç»ƒé¡ºåˆ©! ğŸš€
