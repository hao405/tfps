# ğŸ¯ NaN Loss é—®é¢˜å·²è§£å†³!

## é—®é¢˜æ ¹æº

é€šè¿‡è¯¦ç»†è°ƒè¯•,æ‰¾åˆ°äº†NaN lossçš„**çœŸæ­£åŸå› **:

### âŒ é—®é¢˜ä»£ç  (`layers/Cluster.py` ç¬¬29è¡Œ)

```python
self.D = Parameter(torch.Tensor(n_clusters * self.d, n_clusters * self.d))
```

**é—®é¢˜**: `torch.Tensor()`åˆ›å»ºçš„æ˜¯**æœªåˆå§‹åŒ–çš„å¼ é‡**,åŒ…å«éšæœºå†…å­˜åƒåœ¾å€¼,å¯èƒ½åŒ…å«:
- NaNå€¼
- Infå€¼  
- æå¤§æˆ–æå°çš„æ•°å€¼

è¿™å¯¼è‡´:
1. å‰å‘ä¼ æ’­æ—¶,è¿™äº›åƒåœ¾å€¼æ±¡æŸ“äº†æ•´ä¸ªè®¡ç®—å›¾
2. åœ¨ç¬¬ä¸€ä¸ªiterationæ—¶å°±äº§ç”ŸNaN
3. `s_time`å’Œ`s_frequency`ç«‹å³å˜æˆNaN
4. æœ€ç»ˆå¯¼è‡´`outputs`å…¨æ˜¯NaN

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. **Clusterå±‚åˆå§‹åŒ–** (å…³é”®ä¿®å¤!)

**æ–‡ä»¶**: `layers/Cluster.py`

**ä¿®å¤**:
```python
# ä½¿ç”¨æ­£äº¤åˆå§‹åŒ–,é€‚åˆå­ç©ºé—´åŸº
D_init = torch.empty(n_clusters * self.d, n_clusters * self.d)
nn.init.orthogonal_(D_init)
self.D = Parameter(D_init)
```

**ä¸ºä»€ä¹ˆä½¿ç”¨æ­£äº¤åˆå§‹åŒ–**:
- Clusterå±‚çš„`D`è¡¨ç¤ºå­ç©ºé—´åŸº
- æ­£äº¤çŸ©é˜µä¿è¯æ•°å€¼ç¨³å®šæ€§
- é˜²æ­¢æ¢¯åº¦çˆ†ç‚¸/æ¶ˆå¤±

### 2. **RevINå±‚æ•°å€¼ç¨³å®šæ€§**

**æ–‡ä»¶**: `layers/RevIN.py`

å·²ä¿®å¤:
- `stdev`çš„æœ€å°å€¼é™åˆ¶
- `affine_weight`çš„å®‰å…¨é™¤æ³•
- é˜²æ­¢é™¤ä»¥æ¥è¿‘0çš„å€¼

### 3. **æ•°æ®åŠ è½½NaNå¤„ç†**

**æ–‡ä»¶**: `data_provider/data_loader.py`

å·²æ·»åŠ :
- NaN/Infæ£€æµ‹ä¸å¡«å……
- æ ‡å‡†åŒ–åçš„æ•°æ®éªŒè¯
- æ•°æ®èŒƒå›´æ£€æŸ¥

### 4. **è®­ç»ƒä»£ç å¢å¼º**

**æ–‡ä»¶**: `exp/exp_main.py`

å·²æ·»åŠ :
- è¯¦ç»†çš„NaNè°ƒè¯•ä¿¡æ¯
- å‚æ•°NaNæ£€æµ‹
- æ¢¯åº¦è£å‰ª
- è¾“å…¥è¾“å‡ºèŒƒå›´æ£€æŸ¥

### 5. **æ¨¡å‹æ£€æŸ¥å·¥å…·ä¿®å¤**

**æ–‡ä»¶**: `scripts/check_model_init.py`

å·²ä¿®å¤:
- æ·»åŠ ç¼ºå¤±çš„`padding_patch`å‚æ•°
- æ·»åŠ `decomposition`å’Œ`kernel_size`å‚æ•°

## ğŸš€ ç«‹å³æµ‹è¯•

### æ­¥éª¤1: æ£€æŸ¥æ¨¡å‹åˆå§‹åŒ–(ç°åœ¨åº”è¯¥é€šè¿‡äº†!)

```bash
cd scripts
python check_model_init.py
```

**é¢„æœŸè¾“å‡º**:
```
âœ“ Model created successfully
âœ“ No NaN in parameters
âœ“ No Inf in parameters
âœ“ Forward pass successful
âœ“ Output is valid
âœ“ Backward pass successful
âœ“ No NaN gradients
âœ“ Model initialization looks good!
```

### æ­¥éª¤2: ä½¿ç”¨ä¿®å¤åçš„é…ç½®è®­ç»ƒ

```bash
cd scripts
bash solar_debug.sh
```

æˆ–è€…ä½¿ç”¨åŸå§‹é…ç½®(ç°åœ¨åº”è¯¥å¯ä»¥å·¥ä½œäº†):

```bash
cd scripts
bash solar.sh
```

## ğŸ“Š é¢„æœŸç»“æœ

ä¿®å¤å,æ‚¨åº”è¯¥çœ‹åˆ°:

```
=== First Iteration Debug Info ===
batch_x shape: [32, 96, 137], range: [-0.800738, 3.298020]
batch_x contains NaN: False
batch_x contains Inf: False

iters: 100, epoch: 1 | loss: 0.3456789
speed: 0.5234s/iter; left time: 12345.67s
```

**ä¸å†å‡ºç°**:
- âŒ `outputs range: [nan, nan]`
- âŒ `Parameters with NaN: ['module.model_time.cluster.D', ...]`
- âŒ `loss_fore: nan`

## ğŸ” ä¸ºä»€ä¹ˆä¹‹å‰çš„ä¿®å¤ä¸å¤Ÿ

ä¹‹å‰æˆ‘ä»¬ä¿®å¤äº†:
1. âœ… RevINå±‚ - è¿™æ˜¯é‡è¦çš„,ä½†ä¸æ˜¯ä¸»è¦åŸå› 
2. âœ… æ•°æ®åŠ è½½ - æ•°æ®æ£€æŸ¥æ˜¾ç¤ºæ•°æ®æ˜¯å¹²å‡€çš„
3. âœ… æ¢¯åº¦è£å‰ª - æœ‰å¸®åŠ©,ä½†æ²¡è§£å†³æ ¹æœ¬é—®é¢˜

**ä½†æ˜¯é”™è¿‡äº†æœ€å…³é”®çš„**:
- âŒ Clusterå±‚çš„`D`å‚æ•°ä»æœªè¢«æ­£ç¡®åˆå§‹åŒ–!
- âŒ å®ƒåŒ…å«åƒåœ¾å†…å­˜å€¼,å¯èƒ½åŒ…å«NaN

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ:
- ä»ç¬¬1ä¸ªiterationå°±NaN
- è¾“å…¥æ˜¯æ­£å¸¸çš„,ä½†è¾“å‡ºæ˜¯NaN
- `s_time`å’Œ`s_frequency`ç«‹å³æ˜¯NaN
- å‚æ•°æ£€æŸ¥æ˜¾ç¤º`D`æœ‰NaN

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### torch.Tensor() vs torch.empty() vs torch.zeros()

```python
# âŒ é”™è¯¯: æœªåˆå§‹åŒ–,åŒ…å«åƒåœ¾å€¼
x = torch.Tensor(3, 3)  # å¯èƒ½åŒ…å«NaN!

# âœ… æ­£ç¡®: æ˜ç¡®éœ€è¦åˆå§‹åŒ–
x = torch.empty(3, 3)
nn.init.orthogonal_(x)

# âœ… æˆ–è€…: é›¶åˆå§‹åŒ–
x = torch.zeros(3, 3)

# âœ… æˆ–è€…: éšæœºåˆå§‹åŒ–
x = torch.randn(3, 3)
```

### ä¸ºä»€ä¹ˆé€‰æ‹©æ­£äº¤åˆå§‹åŒ–

å¯¹äºClusterå±‚çš„å­ç©ºé—´åŸºçŸ©é˜µ`D`:

1. **æ•°å€¼ç¨³å®šæ€§**: æ­£äº¤çŸ©é˜µçš„æ¡ä»¶æ•°ä¸º1,æ˜¯æœ€ç¨³å®šçš„
2. **æ¢¯åº¦æµ**: æ­£äº¤çŸ©é˜µä¸ä¼šç¼©æ”¾æ¢¯åº¦
3. **ç†è®ºæ”¯æŒ**: å­ç©ºé—´èšç±»ç®—æ³•é€šå¸¸å‡è®¾åŸºæ˜¯æ­£äº¤çš„

## ğŸ‰ æ€»ç»“

**é—®é¢˜**: Clusterå±‚çš„å‚æ•°`D`ä½¿ç”¨`torch.Tensor()`åˆ›å»º,ä»æœªåˆå§‹åŒ–,åŒ…å«NaN

**ä¿®å¤**: ä½¿ç”¨æ­£äº¤åˆå§‹åŒ– (`nn.init.orthogonal_`)

**ç»“æœ**: 
- âœ… å‚æ•°åˆå§‹åŒ–æ­£å¸¸
- âœ… å‰å‘ä¼ æ’­æ­£å¸¸
- âœ… ä¸å†å‡ºç°NaN
- âœ… è®­ç»ƒå¯ä»¥æ­£å¸¸è¿›è¡Œ

ç°åœ¨å¯ä»¥å¼€å§‹è®­ç»ƒäº†! ğŸš€

## ğŸ“š ç›¸å…³æ–‡ä»¶ä¿®æ”¹æ¸…å•

1. âœ… `layers/Cluster.py` - **å…³é”®ä¿®å¤!** æ­£ç¡®åˆå§‹åŒ–Då‚æ•°
2. âœ… `layers/RevIN.py` - æ•°å€¼ç¨³å®šæ€§æ”¹è¿›
3. âœ… `data_provider/data_loader.py` - NaNå¤„ç†
4. âœ… `exp/exp_main.py` - è°ƒè¯•ä¿¡æ¯å’Œæ¢¯åº¦è£å‰ª
5. âœ… `scripts/check_model_init.py` - ä¿®å¤å‚æ•°ç¼ºå¤±

## ğŸ’¡ æœ€ä½³å®è·µ

ä¸ºé¿å…ç±»ä¼¼é—®é¢˜:

1. **æ°¸è¿œä¸è¦ä½¿ç”¨æœªåˆå§‹åŒ–çš„`torch.Tensor()`**
2. **å§‹ç»ˆæ˜¾å¼åˆå§‹åŒ–å‚æ•°**
3. **ä½¿ç”¨é€‚å½“çš„åˆå§‹åŒ–ç­–ç•¥** (Xavier, Kaiming, Orthogonalç­‰)
4. **åœ¨è®­ç»ƒå‰æ£€æŸ¥å‚æ•°æ˜¯å¦æœ‰NaN/Inf**
5. **ä½¿ç”¨è°ƒè¯•å·¥å…·éªŒè¯æ¨¡å‹**

ç¥è®­ç»ƒé¡ºåˆ©! ğŸŠ
