# ğŸš€ ä»é›¶å¼€å§‹ï¼šå½»åº•è§£å†³ NaN é—®é¢˜

## ç¬¬ä¸€æ­¥ï¼šéªŒè¯ä¿®å¤ âœ“

```powershell
cd e:\experiment\TFPS-main
python verify_fixes.py
```

**æœŸæœ›è¾“å‡º**ï¼š
```
ğŸ‰ æ‰€æœ‰ä¿®å¤å·²æ­£ç¡®åº”ç”¨ï¼å¯ä»¥å®‰å…¨å¼€å§‹è®­ç»ƒã€‚
```

å¦‚æœæœ‰ âŒï¼Œè¯´æ˜ä¿®å¤æœªå®Œå…¨åº”ç”¨ï¼Œéœ€è¦é‡æ–°æ£€æŸ¥ç›¸åº”æ–‡ä»¶ã€‚

---

## ç¬¬äºŒæ­¥ï¼šè¿è¡Œè¯Šæ–­ ğŸ”

```powershell
python diagnose_nan.py
```

**æœŸæœ›è¾“å‡º**ï¼š
```
DATA: âœ… é€šè¿‡
INIT: âœ… é€šè¿‡
FORWARD: âœ… é€šè¿‡
LOSS: âœ… é€šè¿‡

ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼æ¨¡å‹é…ç½®æ­£å¸¸ã€‚
```

å¦‚æœæœ‰å¤±è´¥é¡¹ï¼ŒæŸ¥çœ‹è¯¦ç»†è¾“å‡ºå¹¶æ ¹æ®æç¤ºè°ƒæ•´ã€‚

---

## ç¬¬ä¸‰æ­¥ï¼šæµ‹è¯•è®­ç»ƒ ğŸ§ª

### æ–¹æ¡ˆAï¼šä½¿ç”¨é»˜è®¤è„šæœ¬ï¼ˆæ¨èåˆå­¦è€…ï¼‰

```powershell
cd scripts
bash etth1.sh
```

### æ–¹æ¡ˆBï¼šè‡ªå®šä¹‰å®‰å…¨é…ç½®ï¼ˆæ¨èæœ‰ç»éªŒç”¨æˆ·ï¼‰

åˆ›å»º `test_train.sh`:
```bash
#!/bin/bash

python -u run_longExp.py \
  --random_seed 2021 \
  --is_training 1 \
  --root_path ./dataset/ETT-small/ \
  --data_path ETTh1.csv \
  --model_id test_nan_fix \
  --model PatchTST_MoE_cluster \
  --data ETTh1 \
  --features M \
  --seq_len 96 \
  --pred_len 96 \
  --enc_in 7 \
  --c_out 7 \
  --e_layers 3 \
  --n_heads 4 \
  --d_model 16 \
  --d_ff 128 \
  --dropout 0.3 \
  --fc_dropout 0.3 \
  --head_dropout 0 \
  --patch_len 16 \
  --stride 8 \
  --T_num_expert 4 \
  --T_top_k 1 \
  --F_num_expert 4 \
  --F_top_k 1 \
  --beta 0.001 \
  --alpha 1.0 \
  --gama 1.0 \
  --learning_rate 0.0005 \
  --batch_size 32 \
  --train_epochs 10 \
  --patience 10 \
  --lradj TST \
  --pct_start 0.3 \
  --itr 1 \
  --gpu 0
```

è¿è¡Œï¼š
```powershell
bash test_train.sh
```

---

## ç¬¬å››æ­¥ï¼šç›‘æ§è®­ç»ƒ ğŸ‘€

### å…³é”®æŒ‡æ ‡ï¼š

**å‰100æ¬¡è¿­ä»£**ï¼ˆçº¦1-2åˆ†é’Ÿï¼‰ï¼š
- âœ… Loss å¹³æ»‘ä¸‹é™
- âœ… æ—  "Warning: NaN" æ¶ˆæ¯
- âœ… æ¢¯åº¦èŒƒæ•° < 10

**ç¬¬500æ¬¡è¿­ä»£**ï¼ˆè‡ªåŠ¨è¯Šæ–­ç‚¹ï¼‰ï¼š
```
==================================================
Model Diagnostics at Iteration 500
==================================================
input_data: {'mean': 0.xx, 'std': 0.xx, 'status': 'OK'}
==================================================
```
- âœ… æ—  "NON_STATIONARY_WARNING"
- âœ… æ—  "CRITICAL" çŠ¶æ€å‚æ•°

**ç¬¬1ä¸ªEpochç»“æŸ**ï¼š
```
Epoch: 1, Steps: XXX | Train Loss: 0.XXX Vali Loss: 0.XXX Test Loss: 0.XXX
```
- âœ… æ‰€æœ‰Losséƒ½æ˜¯æ­£å¸¸æ•°å€¼ï¼ˆ0.1-1.0èŒƒå›´ï¼‰
- âœ… Train Loss < Vali Lossï¼ˆè½»å¾®è¿‡æ‹Ÿåˆæ˜¯æ­£å¸¸çš„ï¼‰

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### æƒ…å†µ1ï¼šverify_fixes.py å¤±è´¥

**é—®é¢˜**ï¼šæŸäº›ä¿®å¤æœªåº”ç”¨

**è§£å†³**ï¼š
1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«æ­£ç¡®ç¼–è¾‘
2. æœç´¢å¤±è´¥çš„æ£€æŸ¥é¡¹å…³é”®è¯
3. æ‰‹åŠ¨å¯¹æ¯” NON_STATIONARY_FIXES.md ä¸­çš„ä»£ç 

### æƒ…å†µ2ï¼šdiagnose_nan.py å¤±è´¥

**é—®é¢˜**ï¼šDATAæµ‹è¯•å¤±è´¥
- æ£€æŸ¥æ•°æ®è·¯å¾„
- æ£€æŸ¥æ•°æ®æ ¼å¼ï¼ˆCSVï¼Œæœ‰headerï¼‰
- è¿è¡Œï¼š`python -c "import pandas as pd; print(pd.read_csv('dataset/ETT-small/ETTh1.csv').head())"`

**é—®é¢˜**ï¼šINITæµ‹è¯•å¤±è´¥
- é™ä½æ¨¡å‹å¤æ‚åº¦ï¼š`--d_model 8 --T_num_expert 2 --F_num_expert 2`
- æ£€æŸ¥CUDA/GPUæ˜¯å¦å¯ç”¨

**é—®é¢˜**ï¼šFORWARDæµ‹è¯•å¤±è´¥
- è¿™æ˜¯ä¸¥é‡é—®é¢˜ï¼Œå¯èƒ½éœ€è¦é‡æ–°åº”ç”¨æ‰€æœ‰ä¿®å¤
- æ£€æŸ¥Cluster.pyä¸­çš„æ‰€æœ‰ä¿®æ”¹æ˜¯å¦æ­£ç¡®

**é—®é¢˜**ï¼šLOSSæµ‹è¯•å¤±è´¥
- æ£€æŸ¥Constraint.pyçš„è®¾å¤‡åŒ¹é…ä¿®å¤
- é™ä½betaå€¼ï¼š`--beta 0.0001`

### æƒ…å†µ3ï¼šè®­ç»ƒæ—¶ä»å‡ºç°NaN

**ç«‹å³æ£€æŸ¥**ï¼š
1. å“ªä¸ªiterationå‡ºç°çš„ï¼Ÿ
   - å¦‚æœ < 10ï¼šåˆå§‹åŒ–é—®é¢˜ï¼Œé‡æ–°è¿è¡Œdiagnose_nan.py
   - å¦‚æœ > 100ï¼šæ•°æ®é—®é¢˜ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æç«¯å€¼

2. ä»€ä¹ˆç±»å‹çš„Lossæ˜¯NaNï¼Ÿ
   ```python
   # åœ¨è®­ç»ƒè„šæœ¬ä¸­æ·»åŠ æ‰“å°
   print(f"loss_fore: {loss_fore.item()}")
   print(f"loss_cluster_time: {loss_cluster_time.item()}")
   print(f"loss_cluster_frequency: {loss_cluster_frequency.item()}")
   ```

3. ç´§æ€¥é™çº§ï¼š
   ```bash
   # ç¦ç”¨èšç±»æŸå¤±
   --beta 0.0 --alpha 0.0 --gama 0.0
   
   # å¦‚æœè¿™æ ·èƒ½è®­ç»ƒï¼Œé€æ­¥å¢åŠ ï¼š
   --beta 0.0001  # ç¬¬ä¸€æ¬¡å°è¯•
   --beta 0.001   # ç¬¬äºŒæ¬¡å°è¯•
   --beta 0.01    # ç¬¬ä¸‰æ¬¡å°è¯•
   ```

---

## ğŸ“Š æˆåŠŸè®­ç»ƒçš„æ ‡å¿—

**æ­£å¸¸çš„è®­ç»ƒè¾“å‡ºç¤ºä¾‹**ï¼š
```
Epoch: 1, Steps: 100 | Train Loss: 0.4523 Vali Loss: 0.5012 Test Loss: 0.4891
Epoch: 2, Steps: 100 | Train Loss: 0.3821 Vali Loss: 0.4567 Test Loss: 0.4321
Epoch: 3, Steps: 100 | Train Loss: 0.3245 Vali Loss: 0.4234 Test Loss: 0.4123
...
```

**å…³é”®ç‰¹å¾**ï¼š
- âœ… Loss å•è°ƒé€’å‡ï¼ˆå…è®¸å°å¹…æ³¢åŠ¨ï¼‰
- âœ… æ‰€æœ‰Lossåœ¨åŒä¸€æ•°é‡çº§ï¼ˆ0.1-1.0ï¼‰
- âœ… Vali Loss ç•¥é«˜äº Train Loss
- âœ… æ— å¼‚å¸¸è­¦å‘Šä¿¡æ¯

---

## ğŸ“ è¿›é˜¶ï¼šä¼˜åŒ–è¶…å‚æ•°

è®­ç»ƒç¨³å®šåï¼Œå¯ä»¥å°è¯•ï¼š

1. **å¢åŠ æ¨¡å‹å®¹é‡**ï¼š
   ```bash
   --d_model 32 --d_ff 256 --T_num_expert 8 --F_num_expert 8
   ```

2. **è°ƒæ•´èšç±»æƒé‡**ï¼š
   ```bash
   # å¢åŠ èšç±»æŸå¤±å½±å“
   --beta 0.01 --alpha 2.0 --gama 2.0
   ```

3. **æ›´æ¿€è¿›çš„å­¦ä¹ ç‡**ï¼š
   ```bash
   --learning_rate 0.001
   --lradj TST
   --pct_start 0.2  # æ›´å¿«çš„warmup
   ```

4. **æ›´é•¿çš„è®­ç»ƒ**ï¼š
   ```bash
   --train_epochs 100
   --patience 20
   ```

---

## ğŸ“ è·å–å¸®åŠ©

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œå‡†å¤‡ä»¥ä¸‹ä¿¡æ¯ï¼š

1. `verify_fixes.py` å®Œæ•´è¾“å‡º
2. `diagnose_nan.py` å®Œæ•´è¾“å‡º
3. è®­ç»ƒæ—¥å¿—å‰100è¡Œ
4. å®Œæ•´çš„å‘½ä»¤è¡Œå‚æ•°
5. Pythonç‰ˆæœ¬ã€PyTorchç‰ˆæœ¬ã€CUDAç‰ˆæœ¬

---

## âœ… æ£€æŸ¥æ¸…å•

è®­ç»ƒå‰æœ€åç¡®è®¤ï¼š

- [ ] `verify_fixes.py` å…¨éƒ¨é€šè¿‡
- [ ] `diagnose_nan.py` å…¨éƒ¨é€šè¿‡
- [ ] ä½¿ç”¨ä¿å®ˆçš„è¶…å‚æ•°ï¼ˆbeta=0.001, lr=0.0005ï¼‰
- [ ] æ‰¹æ¬¡å¤§å° â‰¥ 32
- [ ] Expertæ•°é‡ â‰¤ 8ï¼ˆé¦–æ¬¡è®­ç»ƒï¼‰
- [ ] å‡†å¤‡å¥½ç›‘æ§è¾“å‡º

**å‡†å¤‡å®Œæ¯•ï¼Œå¼€å§‹è®­ç»ƒï¼** ğŸš€
